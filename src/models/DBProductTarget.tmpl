-- AUTO GENERATED By codegen_builder, DO NOT EDIT
{{$projectName := .ProductSource -}}
{{$companyName := .Company -}}

{{- range $index, $element := .ProductTargets.Types -}}
{{if $element }}
CREATE TYPE {{ $index -}} (
{{- $lenProperties := len $element -}}
{{- range $index, $item := $element}}
  {{$item.Name}}{{if (isLast $index $lenProperties)}}{{- else}},
{{- end -}}
{{- end}}
);
{{end}}
{{- end -}}

{{- range $index, $element := .ProductTargets.Structs -}}
--{{$index.Name}}
CREATE TABLE IF NOT EXISTS {{$index.ProductSource}}.{{$index.Name -}}(
{{- $lenProperties := len $element -}}
{{- range $index, $item := $element}} 
    {{.Name}} {{.TypeName}}{{if (isLast $index $lenProperties)}},{{- else}},
    {{- end -}}
{{end}}
    PRIMARY KEY{{range $index, $item := $element -}}
    {{if eq $index 0}}({{.Name}}{{if ne $index 0}}{{.Name}}{{end}}){{end}}{{else}}break
{{end}}
);
{{end -}}

{{- range $index, $element := .ProductTargets.Structs}}
{{$target := index $element 0}}--{{$target.Name}} 
CREATE MATERIALIZED VIEW IF NOT EXISTS {{$index.Name}}_by_{{$target.Name}} AS 
  SELECT * FROM {{$index.Name}}
{{- range $index, $item := $element -}} 
  {{if eq $index 0}}
  WHERE {{.Name}} IS NOT NULL
  {{- else}}{{if ne $index 0}}
  AND {{.Name }} IS NOT NULL
  {{- else -}}{{ end -}}
{{end}}{{end}}
  PRIMARY KEY({{range $index, $item := $element -}} 
{{$lenProperties := len $element -}}
    {{- .Name}}{{if (isLast $index $lenProperties)}}{{else}},{{end -}}
{{end}});
{{end}}

{{range $index, $element := .ProductTargets.Index -}}
{{if $element }}
CREATE INDEX {{ $index.Name }} ON {{$index.Table -}} (
{{- $lenProperties := len $element -}}
{{- range $index, $item := $element}}
    {{$item.Name}}{{if (isLast $index $lenProperties)}}{{- else}},
{{- end -}}
{{- end}}
);
{{end}}
{{- end}}